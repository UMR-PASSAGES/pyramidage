<!DOCTYPE html>

<html>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <head>
    	<title>Pyramidage</title>
    	<meta charset="utf-8" />
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
        <link rel="stylesheet" href="https://drvic10k.github.io/bootstrap-sortable/Contents/bootstrap-sortable.css" />
        <script src="js/jquery-3.4.1.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
        <script src="js/jquery-ui.min.js"></script>
        <script src="js/d3.min.js"></script>
        <script src="https://d3js.org/d3-color.v1.min.js"></script>
        <script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
        <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
        <script src="js/papaparse.min.js"></script>
        <script src="js/FileSaver.min.js"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.19.1/moment.js"></script>
        <script src="https://drvic10k.github.io/bootstrap-sortable/Scripts/bootstrap-sortable.js"></script>
        
    </head>
    <style>
        div#graph{
            border: 0px solid black;
            overflow-x: scroll;
            overflow-y: hidden;
        }
        div.tooltip {
            position: absolute;
            text-align: center;
            width: 60px;
            height: 28px;
            padding: 2px;
            font: 12px sans-serif;
            background: white;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
            }
        .table-scrollable{
            max-height: 300px;
            overflow: auto;
            display:inline-block;
        }
        figure{
            display: block;
            text-align: center;
            font-style: italic;
            font-size: small;
        }
        img{
            padding: 10px;
        } 
    </style>    
    
    <body class="bg-light">
        <div class="container-fluid">
            
             <!-- presentation -->
            <h2>Pyramidage</h2>
            <p class="text-justify">Pyramidage est un outil en ligne pour créer des pyramides des âges automatiquement à partir d'un fichier CSV.</p>
            <ul>
                <li><a href="#pourquoi">A quoi ça sert ?</a></li>
                <li><a href="#comment">Comment ça marche ?</a></li>
                <li><a href="#maisencore">Mais encore ?</a></li>
            </ul>
            <hr>
            
            <!-- important part -->
            <div class="row">
            
                <div class="col-sm-12" id="col0">
                
                    <h4>Données en entrée</h4>
                
                    <!-- input CSV file -->
                    <div class="row">
                        <div class="col-2">
                            <label for="inputFile" class="btn btn-secondary btn-block btn-outlined">Fichier CSV</label>
                            <input type="file" id="inputFile" accept=".csv" name="Fichier CSV"/ style="display: none">
                        </div>
                        <div class="col-8">
                            <p id="fileName"></p>
                        </div>
                    </div>
                    
                    <br>
                    
                    <!-- div for CSV preview -->
                    <div class="row">
                        <div class="col">
                            <div id="divPreview" class="table-responsive table-scrollable"></div>
                        </div>
                    </div>
                    <hr>
                </div>
                

            
                <div class="col-sm-4" id="col1">
                
                    <h4>Paramètres</h4>

                    <!-- input parameters -->
                    <div class="row">
                        <!-- current year -->
                        <div class="col-sm-8">
                            <label for="currentYear">Année :</label>
                        </div>
                        <div class="col-sm-4">
                            <input class="form-control" type="number" id="currentYear" min="1000" max="2099" step="1" value="2019" />
                        </div>
                        <div class="w-100"></div>
                        <!-- column for birth year -->
                        <div class="col-sm-8">
                            <label for="colYear">Année de naissance :</label>
                        </div>
                        <div class="col-sm-4">
                            <select class="custom-select d-block w-100" id="colYear"></select>
                        </div>
                        <div class="w-100"></div>
                        <!-- column for sex -->
                        <div class="col-sm-8">
                            <label for="colSex">Sexe :</label>
                        </div>
                        <div class="col-sm-4">
                            <select class="custom-select d-block w-100" id="colSex"></select>
                        </div>
                        <div class="w-100"></div>
                        <!-- column for category -->
                        <div class="col-sm-8">
                            <label for="colCat">Catégorie :</label>
                        </div>
                        <div class="col-sm-4">
                            <select class="custom-select d-block w-100" id="colCat"></select>
                        </div>
                        <div class="w-100"></div>
                        <!-- column for tooltip -->
                        <div class="col-sm-8">
                            <label for="colTooltip">Infobulle :</label>
                        </div>
                        <div class="col-sm-4">
                            <select class="custom-select d-block w-100" id="colTooltip"></select>
                        </div>
                        <div class="w-100"></div>
                        <!-- column for class size -->
                        <div class="col-sm-8">
                            <label for="classSize">Taille des classes d'âge :</label>
                        </div>
                        <div class="col-sm-4">
                            <input class="form-control" type="number" id="classSize" min="1" max="1000" step="1" value="5" />
                        </div>
                        <div class="w-100"></div>
                        <!-- beginning of first age class -->
                        <div class="col-sm-8">
                            <label for="beginFirstClass">Début de la première classe d'âge :</label>
                        </div>
                        <div class="col-sm-4">
                            <input class="form-control" type="number" id="beginFirstClass" min="0" max="1000" step="1" value="25" />
                        </div>
                        <div class="w-100"></div>
                        <!-- end of last age class -->
                        <div class="col-sm-8">
                            <label for="endLastClass">Fin de la dernière classe d'âge :</label>
                        </div>   
                        <div class="col-sm-4">
                            <select class="custom-select d-block w-20" id="endLastClass"></select>
                        </div>
                        <!-- type of color scale -->
                        <div class="col-sm-8">
                            <label for="colorScaleType">Type de gamme de couleur :</label>
                        </div>   
                        <div class="col-sm-4">
                            <select class="custom-select d-block w-20" id="colorScaleType"></select>
                        </div>
                        <!-- color scale -->
                        <div class="col-sm-8">
                            <label for="colorScale">Gamme de couleur :</label>
                        </div>   
                        <div class="col-sm-4">
                            <select class="custom-select d-block w-20" id="colorScale"></select>
                        </div>
                        <!-- Représentation du sexe -->
                        <div class="col-sm-8">
                            <label for="sexRep">Répartition des sexes :</label>
                        </div>   
                        <div class="col-sm-4">
                            <select class="custom-select d-block w-20" id="sexRep"></select>
                        </div>
                    </div>
                    <br>
                    
                    <!-- category table -->
                    <h4>Catégories</h4>
                    
                    <div class="col">
                        <div class="table-responsive table-scrollable">
                            <table class="table table-sm table-hover sortable" id="catTable">
                                <thead class="thead-light">
                                    <tr>
                                        <th scope="col">Catégorie</th>
                                        <th scope="col">Couleur</th>
                                        <th scope="col">Effectif</th>
                                    </tr>
                                </thead>
                                <tbody id="catTableTbody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <br>
                    
                    <!-- buttons -->
                    <div class="row">
                        <!-- create graph -->
                        <div class="col-6">
                            <button type="button" class="btn btn-primary btn-block" id="createGraph">Construire une pyramide !</button>
                        </div>
                        <!-- output SVG file -->
                        <div class="col-6">
                            <button type="submit" class="btn btn-secondary btn-block" id="svgExport">Export SVG</button>
                        </div>
                    </div>
                    
                </div>
                
                <div class="col-sm-8" id="col2">
                    <div id="graph"></div>
                </div>
            </div>
                
            <hr>
            
            <div class="row">
                <div class="col">
                    <h3><a id="pourquoi">A quoi ça sert ?</a></h3>
                    <p class="text-justify">Pyramidage est un outil en ligne pour créer des pyramides des âges automatiquement à partir d'un fichier CSV.</p>
                    <a href="illustrations/principe_pyramidage.svg"><img src="illustrations/principe_pyramidage.svg" alt="Principe de l'outil : du tableau CSV à la pyramide des âges" width="1000px"></a>
                    <p class="text-justify>">Cet outil présente 3 intérêts :
                        <ul>
                            <li>Faire varier facilement la taille des classes d'âge et les âges minimum et maximum</li>
                            <li>Visualiser 2 variables en plus de l'âge et du sexe, une avec la couleur et l'autre avec une infobulle (en passant la souris sur la pyramide)</li>
                            <li>Exporter le résultat en SVG pour pouvoir le modifier dans un logiciel de dessin vectoriel, en gardant comme identifiant l'information affichée dans l'infobulle.</li>
                        </ul>
                    </p>
                    <p>Cet outil n'est pas pour l'instant adapté à de gros jeux de données.</p>
                    <p>Une pyramide des âges permet de visualiser la répartition de la population en fonction du sexe et de l'âge. Elle est consituée de deux histogrammes juxtaposées, traditionnellement les hommes à gauche et les femmes à droite. L'axe horizontal représente le nombre d'individus, et l'axe vertical l'âge des individus.</p>
                </div>
            </div>
                
            <hr>
                    
            <div class="row">
                <div class="col">
                    <h3><a id="comment">Comment ça marche ?</a></h3>
                        <div class="row">
                            <div class="col-sm-2">
                                <div class="list-group" id="list-tab" role="tablist">
                                    <a class="list-group-item list-group-item-action active" id="list-input-list" data-toggle="list" href="#list-input" role="tab" aria-controls="input">Fichier en entrée</a>
                                    <a class="list-group-item list-group-item-action" id="list-year-list" data-toggle="list" href="#list-year" role="tab" aria-controls="year">Année</a>
                                    <a class="list-group-item list-group-item-action" id="list-birthyear-list" data-toggle="list" href="#list-birthyear" role="tab" aria-controls="birthyear">Année de naissance</a>
                                    <a class="list-group-item list-group-item-action" id="list-sex-list" data-toggle="list" href="#list-sex" role="tab" aria-controls="sex">Sexe</a>
                                    <a class="list-group-item list-group-item-action" id="list-cat-list" data-toggle="list" href="#list-cat" role="tab" aria-controls="cat">Catégorie</a>
                                    <a class="list-group-item list-group-item-action" id="list-tooltip-list" data-toggle="list" href="#list-tooltip" role="tab" aria-controls="tooltip">Infobulle</a>
                                    <a class="list-group-item list-group-item-action" id="list-classsize-list" data-toggle="list" href="#list-classsize" role="tab" aria-controls="classsize">Taille classe d'âge</a>
                                    <a class="list-group-item list-group-item-action" id="list-beginfirstclass-list" data-toggle="list" href="#list-beginfirstclass" role="tab" aria-controls="beginfirstclass">Première classe d'âge</a>
                                    <a class="list-group-item list-group-item-action" id="list-endlastclass-list" data-toggle="list" href="#list-endlastclass" role="tab" aria-controls="endlastclass">Dernière classe d'âge</a>
                                    <a class="list-group-item list-group-item-action" id="list-colorscaletype-list" data-toggle="list" href="#list-colorscaletype" role="tab" aria-controls="colorscaletype">Type de gamme de couleur</a>
                                    <a class="list-group-item list-group-item-action" id="list-colorscale-list" data-toggle="list" href="#list-colorscale" role="tab" aria-controls="colorscale">Gamme de couleur</a>
                                    <a class="list-group-item list-group-item-action" id="list-sexrep-list" data-toggle="list" href="#list-sexrep" role="tab" aria-controls="sexrep">Répartition des sexes</a>
                                    <a class="list-group-item list-group-item-action" id="list-cattable-list" data-toggle="list" href="#list-cattable" role="tab" aria-controls="cattable">Tableau des catégories</a>
                                    <a class="list-group-item list-group-item-action" id="list-buildpyramid-list" data-toggle="list" href="#list-buildpyramid" role="tab" aria-controls="buildpyramid">Construire une pyramide</a>
                                    <a class="list-group-item list-group-item-action" id="list-svgexport-list" data-toggle="list" href="#list-svgexport" role="tab" aria-controls="svgexport">Export SVG</a>
                                    
                                </div>
                            </div>
                                <div class="col-sm-8">
                                <div class="tab-content" id="nav-tabContent">
                                    <div class="tab-pane fade show active" id="list-input" role="tabpanel" aria-labelledby="list-input-list">
                                        <p class="text-justify">Le fichier CSV doit contenir :</p>
                                        <ul>
                                            <li>une ligne d'en-tête</li>
                                            <li>une ligne par individu</li>
                                            <li>une colonne pour l'année de naissance</li>
                                            <li>une colonne pour le sexe (facultative si le mode non genré est choisi pour la répartition des sexes)</li>
                                        </ul>
                                        <p class="text-justify">Les colonnes Catégorie et Infobulle sont facultatives.</p>
                                        <p class="text-justify">Le caractère délimiteur (virgule, point-virgule...) est normalement automatiquement détecté.</p>
                                        <p class="text-justify">Une fois le fichier sélectionné, un aperçu de son contenu s'affiche.</p>
                                        <p class="text-justify">Un fichier exemple avec des données aléatoires est disponible <a href="http://ouvrir.passages.cnrs.fr/pyramidage/test_data/test_data_pyramidage.csv">ici</a>.</p>
                                        <figure>
                                            <img src="illustrations/csv.png" alt="Aperçu d'un fichier CSV">
                                            <figcaption>Exemple de fichier CSV utilisable en entrée (données générées aléatoirement). Seule la première colonne est indispensable (année de naissance).</figcaption>
                                        </figure>
                                    </div>
                                    <div class="tab-pane fade" id="list-year" role="tabpanel" aria-labelledby="list-year-list"><p class="text-justify">Choisissez l'année pour laquelle la pyramide sera valable. Il s'agit généralement de l'année en cours.</p></div>
                                    <div class="tab-pane fade" id="list-birthyear" role="tabpanel" aria-labelledby="list-birthyear-list"><p class="text-justify">Sélectionnez la colonne du fichier CSV correspondant à l'année de naissance.</p></div>
                                    <div class="tab-pane fade" id="list-sex" role="tabpanel" aria-labelledby="list-sex-list">
                                        <p class="text-justify">Sélectionnez la colonne du fichier CSV correspondant au sexe.</p>
                                        <p class="text-justify">Le sexe féminin peut être codé par, au choix, F, FEMME, FEMALE, XX.</p>
                                        <p class="text-justify">Le sexe masculin peut être codé par, au choix, M, H, HOMME, MALE, XY.</p>
                                    </div>
                                    <div class="tab-pane fade" id="list-cat" role="tabpanel" aria-labelledby="list-cat-list">
                                        <p class="text-justify">Cette option est facultative.</p>
                                        <p class="text-justify">Vous pouvez choisir une colonne avec des catégories ; chaque individu sera représenté d'une couleur correspondant à sa catégorie.</p>
                                        <p class="text-justify">Les couleurs sont personnalisable, ainsi que l'ordre dans lequel les catégories sont dessinées en partant de l'axe vertical de la pyramide.</p>
                                        <p class="text-justify">Si vous ne choisissez aucune colonne, tous les individus seront représentés de la même couleur.</p>
                                    </div>
                                    <div class="tab-pane fade" id="list-tooltip" role="tabpanel" aria-labelledby="list-tooltip-list">
                                        <p class="text-justify">Cette option est facultative.</p>
                                        <p class="text-justify">Vous pouvez choisir une colonne correspondant à l'information de votre choix. Cette information sera disponible pour chaque individu dans une infobulle en le survolant avec la souris.</p>
                                        <p class="text-justify">Cette information sera également récupérée dans l'export SVG via l'identifiant de chaque carré correspondant à un individu.</p>
                                    </div>
                                    <div class="tab-pane fade" id="list-classsize" role="tabpanel" aria-labelledby="list-classsize-list"><p class="text-justify">Choisissez ici la taille de chaque classe d'âge.</p></div>
                                    <div class="tab-pane fade" id="list-beginfirstclass" role="tabpanel" aria-labelledby="list-beginfirstclass-list">
                                        <p class="text-justify">Choisissez ici l'âge de début de la première classe d'âge. Une classe inférieure sera créée.</p>
                                        <p class="text-justify">Par exemple, si vous choisissez 25, une classe sera créée pour les moins de 25 ans.</p>
                                    </div>
                                    <div class="tab-pane fade" id="list-endlastclass" role="tabpanel" aria-labelledby="list-endlastclass-list">
                                        <p class="text-justify">Choisissez ici l'âge de fin de la dernière classe d'âge. Une classe supérieure sera créée.</p>
                                        <p class="text-justify">Par exemple, si vous choisissez 65, une classe sera créée pour les plus de 65 ans.</p>
                                    </div>
                                    <div class="tab-pane fade" id="list-colorscaletype" role="tabpanel" aria-labelledby="list-colorscaletype-list">
                                        <p class="text-justify">Les gammes de couleur utilisées pour représenter les catégories peuvent être qualitatives, pour représenter des valeurs non ordonnées, ou bien séquentielles, pour représenter des valeurs ordonnées.</p>
                                        <p class="text-justify">Si vos catégories sont des nombres et votre gamme de couleur de type séquentiel, les couleurs extrêmes de la gamme correspondront aux valeurs minimum et maximum de vos catégories, et les couleurs intermédiaires seront interpolées en fonction des valeurs.</p>
                                        <p class="text-justify">Si vos catégories sont des textes et votre gamme de couleur de type séquentiel, les couleurs extrêmes de la gamme correspondront à la première et la dernière catégorie rencontrée dans votre fichier CSV.</p>
                                        <figure>
                                            <img src="illustrations/gamme_couleur_qualitative.png" alt="gamme de couleur qualitative">
                                            <img src="illustrations/gamme_couleur_sequentielle.png" alt="gamme de couleur sequentielle">
                                            <figcaption>Exemples de gammes de couleur qualitative (à gauche) et séquentielle (à droite) issues de <a href="http://colorbrewer2.org/">ColorBrewer</a></figcaption>
                                        </figure>
                                    </div>
                                    <div class="tab-pane fade" id="list-colorscale" role="tabpanel" aria-labelledby="list-colorscale-list">
                                        <p class="text-justify">Différentes gammes de couleurs sont disponibles en fonction du type de gamme. Toutes ces gammes sont issues de <a href="http://colorbrewer2.org/">ColorBrewer</a> via le plugin D3.js <a href="https://github.com/d3/d3-scale-chromatic">d3-scale-chromatic</a>.</p>
                                        <figure>
                                            <img src="illustrations/Set3.png" alt="gamme de couleur schemeSet3">
                                            <figcaption>Gamme de couleur <a href="https://github.com/d3/d3-scale-chromatic#schemeSet3">schemeSet3</a></figcaption>
                                        </figure>
                                        <figure>
                                            <img src="illustrations/category10.png" alt="gamme de couleur Category10">
                                            <figcaption>Gamme de couleur <a href="https://github.com/d3/d3-scale-chromatic#schemeCategory10">schemeCategory10</a></figcaption>
                                        </figure>
                                        <figure>
                                            <img src="illustrations/Accent.png" alt="gamme de couleur Accent">
                                            <figcaption>Gamme de couleur <a href="https://github.com/d3/d3-scale-chromatic#schemeAccent">schemeAccent</a></figcaption>
                                        </figure>
                                    </div>
                                    <div class="tab-pane fade" id="list-sexrep" role="tabpanel" aria-labelledby="list-sexrep-list">
                                        <p class="text-justify">Vous avez le choix entre 3 modes&nbsp;:</p>
                                        <ul>
                                            <li>"traditionnel", les hommes à gauche et les femmes à droite</li>
                                            <li>les femmes à gauche et les hommes à droite</li>
                                            <li>pas de distinction de sexe. La colonne sexe du CSV est alors facultative.</li>
                                        </ul>
                                    </div>
                                    <div class="tab-pane fade" id="list-cattable" role="tabpanel" aria-labelledby="list-cattable-list">
                                        <p class="text-justify">Ce tableau contient 3 colonnes, pour le nom, la couleur et les effectifs de chaque catégorie.</p>
                                        <p class="text-justify">Une fois le fichier CSV choisi, il contient par défaut une seule ligne avec une catégorie unique, et peut contenir plusieurs lignes si vous sélectionnez une colonne catégorie.</p>
                                        <p class="text-justify">Il est possible de changer l'ordre des lignes du tableau par un glisser-déposer, ou bien en cliquant sur le nom des colonnes. L'ordre dans lequel les individus sont dessinés sur la pyramide des âges est alors modifié.</p>
                                        <p>Jusqu'à 12 couleurs, les couleurs sont issues d'une gamme qualitative proposée par <a href="http://colorbrewer2.org/">ColorBrewer</a>. Au-delà, il s'agit de couleurs aléatoires.</p>
                                        <figure>
                                            <img src="illustrations/tableau_categories.png" alt="tableau des catégories">
                                            <figcaption>Exemple de tableau des catégories</figcaption>
                                        </figure>
                                    </div>
                                    <div class="tab-pane fade" id="list-buildpyramid" role="tabpanel" aria-labelledby="list-buildpyramid-list"><p class="text-justify">Après avoir choisi vos paramètres, cliquez sur ce bouton pour afficher la pyramide des âges.</p><p class="text-justify">Le graphique ne se met pas à jour automatiquement, il faut donc reconstruire la pyramide après avoir modifié un paramètre.</p></div>
                                    <div class="tab-pane fade" id="list-svgexport" role="tabpanel" aria-labelledby="list-svgexport-list">
                                        <p class="text-justify">Cliquez sur ce bouton pour obtenir un export SVG de la pyramide.</p>
                                        <p class="text-justify">Chaque carré correspondant à un individu aura un identifiant reprenant l'information de la colonne infobulle si cette colonne a été sélectionnée.</p>
                                        <p class="text-justify">Le SVG est un format vectoriel modifiable dans un logiciel de dessin tel qu'Inkscape ou Adobe Illustrator. Vous pourrez également le convertir dans un format image comme le JPG ou le PNG.</p>
                                        <p class="text-justify">Si vous n'arrivez pas à ouvrir le fichier SVG avec Adobe Illustrator, ouvrez-le avec Inkscape et enregistrez-le à nouveau au format SVG puis réessayez avec Illustrator.</p>
                                    </div>
                                </div>
                            </div>
                      </div>
                </div>
            </div>
            
            <hr>
                
            <div class="row">
                <div class="col">
                    <h3><a id="maisencore">Mais encore ?</a></h3>

                    <p class="text-justify">Pyramidage utilise la bibliothèque javascript <a href="https://d3js.org/">D3.js</a>. Les gammes de couleurs sont celles de <a href="http://colorbrewer2.org">ColorBrewer</a>. Le code complet est disponible <a href="https://github.com/UMR-PASSAGES/pyramidage/">ici</a> et est sous licence <a href="https://www.gnu.org/licenses/quick-guide-gplv3.fr.html">GPLv3</a>.</p>
                    <p class="text-justify">Pour faire une remarque, une suggestion : julie.pierson [@] cnrs.fr (ou @sigomatique sur Twitter).</p>
                    <p class="text-justify">Si vous avez besoin de citer Pyramidage : <em>Julie Pierson, Pyramidage, Pôle ARD UMR 5319 Passages, 2019</em>.</p>
                </div>
            </div>
            
        </div> <!-- end of container div -->
        
    
        <script>
        
            /*
            VARIABLES
            */
            
            // user variables
            var currentYear; // year in which the pyramid is valid
            var classSize; // size of age classes in years
            var beginFirstClass; // min age of first age class ; an inferior class will be created (if 25, there will be a -25 class)
            var endLastClass; // max age of last age class ; a superior class will be created (if 65, there will be a 65+ class)
            var colYear; // index of CSV column for birth year
            var colCat; // index of CSV column for category
            var colSex; // index of CSV column for sex
            var colTooltip; // index of CSV column for the value the user whishes to see as a tooltip
            // male and female can be coded with different values
            var femaleSex = ['F', 'FEMME', 'FEMALE', 'XX'];
            var maleSex = ['H', 'M', 'HOMME', 'MALE', 'XY'];
            
            // graphic variables
            var svg_width = (window.innerWidth)*8/13; // width of svg
            var svg_height = 500; // height of svg
            var barPadding = 2; // padding between squares
            var squareSide; // size of square side
            var minSquareSide = 10; // min value for square size ; svg becomes scrollable if it does not fit in svg with this value for square side
            // qualitative color scales, 1st value is real name, 2nd is label
            var qualiColorScales = [['schemeSet3', 'schemeSet3'], ['schemeCategory10', 'schemeCategory10'], ['schemeAccent', 'schemeAccent']]; 
            // sequential color scales, 1st value is real name, 2nd is label
            var seqColorScales = [['interpolatePurples', 'Violets'], ['interpolateReds', 'Rouges'], ['interpolateOranges', 'Oranges'], ['interpolateGreens', 'Verts'], ['interpolateBlues', 'Bleus'], ['interpolateGreys', 'Gris']];
            var inputArray;
            var catList;
            var colorsForCat = [];
            var colorScaleType;
            var dic_f;
            var dic_m;
            var max_x;
            var graphMargin = 20; // margin on top, bottom, left and right of graph
            var middleSpace = 40; // margin between male and female graph, for age axis
            var svg = d3.select('#graph')
                .append('svg')
                .attr('width', svg_width)
                .attr('height', svg_height)
                .style('background','white')
                .attr("class", 'svgClass');
            var div = d3.select("body").append("div") // div for tooltips
                .attr("class", "tooltip")
                .style("opacity", 0);
            var x_scale_f = d3.scaleLinear() // for x axis female
            var x_scale_m = d3.scaleLinear() // for x axis male
            var y_scale_f = d3.scaleBand() // for y axis female
            var y_scale_m = d3.scaleBand() // for y axis male
              
            
            /*
            FUNCTIONS
            */
            
            // make an array of arrays from CSV file, one array per column
            function csvToArray(inputArray) {
                // transpose array to get one item per column instead of one per row
                inputArray = inputArray[0].map((col, i) => inputArray.map(row => row[i]));
    	        // get column names and removes them from data
    	        columnNames = []
    	        for(i=0; i<inputArray.length; i++) {
    	           columnNames.push(inputArray[i].shift());
    	        }
                return [inputArray, columnNames];
            }
            
            
            // populate colorScale dropdown list
            function populateColorScale() {
                list = document.getElementById('colorScale');
                // remove all options from list
                for(i = list.options.length-1 ; i>=0 ; i--) {
                        list.remove(i);
                }
                // get value for color scale type
                colorScaleType = document.getElementById('colorScaleType').value;
                // get corresponding color scale array
                switch(colorScaleType) {
                	case 'quali':
                	   colorScaleList = qualiColorScales;
                	   break;
                	case 'seq':
                	   colorScaleList = seqColorScales;
                	   break;
                }
                // for each color scale
                for (i=0 ; i<colorScaleList.length ; i++) {
                    // add an option with value and text
                    //list.options.add(new Option(colorScaleList[i][1], colorScaleList[i][0]));
                    list.options.add(new Option(colorScaleList[i][1], colorScaleList[i][0]));
                }

            }
            
            
            // get list of first value for each age class
            function getClasses(beginFirstClass, endLastClass,classSize) {
                listBeginClass = [0];
                for (i=beginFirstClass; i<= endLastClass; i+=classSize) {
            	   listBeginClass.push(i);
                }
                return listBeginClass;
            }
            
            
            // transforms birth year in number of corresponding age class
            // for ex. 37 -> 3 if listBeginClass = [0,25,30,35,40,45,50]
            function getAgeClass(birthYear, currentYear, listBeginClass, classSize) {
                // transforms birth year into beginning of age class, for ex. 37 -> 35
            	age = currentYear - birthYear;
            	ageClass = age - (age-listBeginClass[1])%classSize
            	// replaces values below beginFirstClass by zero
            	if (age < beginFirstClass) { ageClass = 0};
            	// replaces values above endLastClass by endLastClass
            	if (age > endLastClass) { ageClass = endLastClass};
            	nbAgeClass = listBeginClass.indexOf(ageClass);
            	return nbAgeClass;
            }
            
            
            // get max for x axis, = max nb of people in the same age class, for one sex
            function getMaxX(dataset, listBeginClass) {
                // this list will contain as many zeros as age classes
                l = listBeginClass.map((n) => {return 0});
                // for each age class
                for (i=0; i<l.length; i++) {
                	// for each category
                	for (var key in dataset) {
                	   l[i] = l[i] + dataset[key][i].length;
                	}
                }
            	return Math.max.apply(Math, l);
            }
            
            
            // create one graph from one object
            function createGraph(dataset, sex, max_x) {
            
                // get color for each category, as an array of array : [['A', '#66c2a5'], ['B', '#fc8d62'], ...]
                // categories are in the order chosen by user in html table
                getColorsForCat();

                // list which will contain last X for each age class so that categories are stacked on top of the previous one
                // this list contains at first as many 0 as age classes : [0,0,0,0,0,0,0] for ex.
                lastX = listBeginClass.map((n) => {return 0});
                
                // this is used to be sure that each id for svg element is unique
                id = -1;
                
                // for each category
                //for (var key in colorsForCat) {
                for (i=0 ; i<colorsForCat.length ; i++) {
                    // for each age class
                    for (j=0; j<dataset[colorsForCat[i][0]].length; j++){ 
                        // add as many squares as people in that age class
                        svg.selectAll("rect".i)
                          .data(dataset[colorsForCat[i][0]][j])
                          .enter()
                          .append("rect")
                          .attr("y", svg_height-graphMargin-squareSide-j*squareSide)
                          .attr("x", function () { lastX[j] = lastX[j]+squareSide;
                                                    if(sex == 'f') {return svg_width/2 + lastX[j] - squareSide + barPadding/2 + middleSpace/2} 
                                                    else {return svg_width/2 - lastX[j] + barPadding/2 - middleSpace/2}})
                          .attr("height", squareSide - barPadding)
                          .attr("width", squareSide - barPadding)
                          .attr("fill", colorsForCat[i][1])
                          .attr("class", function (d, i) { return i})
                          .attr("id", function (d) {id = id + 1; if (d != '') {return id + sex + '-' + d} else {return id + sex}})
                          // tooltip
                          .on("mouseover", function(d) {
                              div.transition()
                                  .duration(200)
                                  .style("opacity", function() {if (colTooltip != -1) {return 0.9} else {return 0}});
                              div.html(d)
                                  .style("left", (d3.event.pageX) + "px")
                                  .style("top", (d3.event.pageY - 28) + "px")
                              d3.select(this)
                                  .style("opacity", function() {if (colTooltip != -1) {return 0.5} else {return 1}});
                              })
                         .on("mouseout", function(d) {
                           div.transition()
                             .duration(500)
                             .style("opacity", 0)
                             d3.select(this)
                                .style("opacity", 1);
                           });
                    }
                }
                
                // add x axis
                if (sex == 'f') {
                    x_axis_f = d3.axisBottom()
                        .scale(x_scale_f)
                        //.tickSize(0,10)
                        .ticks(max_x);
                    svg.append('g')
                        .attr('transform', 'translate(0, ' + String(svg_height-graphMargin) + ')')
                        .attr("class", "x axis")
                        .call(x_axis_f);
                } else {
                	x_axis_m = d3.axisBottom()
                        .scale(x_scale_m)
                        //.tickSize(0,10)
                        .ticks(max_x);
                    svg.append('g')
                        .attr('transform', 'translate(0, ' + String(svg_height-graphMargin) + ')')
                        .attr("class", "x axis")
                        .call(x_axis_m);
                }
                
                // add y axis
                if (sex == 'f') {
                    y_axis_f = d3.axisRight()
                            .scale(y_scale_f)
                            .tickSize(0,10)
                            .tickValues([]);
                        svg.append('g')
                            .attr('transform', 'translate(' + String(svg_width/2 + middleSpace/2) + ', 0)')
                            .attr("class", "y axis")
                            .call(y_axis_f);
                } else {
                	y_axis_m = d3.axisRight()
                            .scale(y_scale_m)
                            .tickSize(0,10);
                            //.tickPadding(5);
                        svg.append('g')
                            .attr('transform', 'translate(' + String(svg_width/2 - middleSpace/2) + ', 0)')
                            .attr("class", "y axis")
                            .call(y_axis_m);
                }

            }
            
            // display graph legend
            function createLegend() {
            	// for each legend post
            	for (i=0 ; i<colorsForCat.length ; i++) {
            	    // calculate stocks for each cat
            	    var stock = svg.selectAll("[fill='" + colorsForCat[i][1] + "']")
            	       .size();
            	    // add square
                	var legendSquares = svg.append("rect")
                	   .attr("class", "legSquare")
                	   .attr("x", 10)
                	   .attr("y", svg_height + 10 + squareSide * i )
                	   .attr("fill", colorsForCat[i][1])
                	   .attr("width", squareSide - barPadding)
                	   .attr("height", squareSide - barPadding);
                	// add corresponding text
                	var legendText = svg.append("text")
                	   .attr("class", "legText")
                	   .attr("x", 10 + squareSide + barPadding)
                	   .attr("y", svg_height + 10 + squareSide/2 + squareSide * i )
                	   .style("font-size", "0.8em")
                	   .attr("dy", ".35em")
                	   .text(colorsForCat[i][0] + " (" + stock + ")");
                }
                // get legend height
                legHeight = colorsForCat.length * (squareSide + barPadding) + 10;
                // change svg height accordingly
                svg
                    .attr('height', svg_height + legHeight);
                
            }
            
            function addSexIndication() {
                sexRep = document.getElementById('sexRep').value;
                if (sexRep == 'womenLeft') {
                	leftText = 'Femmes';
                	rightText = 'Hommes';
                } else {
                	leftText = 'Hommes';
                	rightText = 'Femmes';
                }
                if (sexRep != 'noGender') {
                    var leftInd = svg.append("text")
                        .attr("class", "sexIndicator")
                        .attr("x", 10)
                        .attr("y", 15)
                        .style("font-size", "1em")
                	    .attr("dy", ".35em")
                	    .text(leftText);
                	var rightInd = svg.append("text")
                        .attr("class", "sexIndicator")
                        .attr("x", svg_width - 70)
                        .attr("y", 15)
                        .style("font-size", "1em")
                	    .attr("dy", ".35em")
                	    .text(rightText);
                }
            }
            
            // display CSV preview as an html table
            function csvPreview(inputArray) {
                // remove existing preview if one
                document.getElementById("divPreview").innerHTML = '';
                // add current file preview
                var container = d3.select("#divPreview")
                    .append("table")
                        .attr("id", "preview")
                        .attr("class", "table table-sm")

                    .selectAll("tr")
                        .data(inputArray).enter()
                        .append("tr")

                    .selectAll("td")
                        .data(function(d) { return d; }).enter()
                        .append("td")
                        .text(function(d) { return d; });
            }
            
            // get random color (from https://stackoverflow.com/a/1484514)
            function getRandomColor() {
              var letters = '0123456789ABCDEF';
              var color = '#';
              for (var i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
              }
              return color;
            }
      
            
            // create color scale
            function setColorScale(uniqueCat) {
                //l = uniqueCat.length
                colorScaleType = document.getElementById('colorScaleType').value;
                colorScaleName = document.getElementById('colorScale').value;
                switch(colorScaleType) {
                    // if qualitative color scale
                    case 'quali':
                        var colorScale = d3.scaleOrdinal()
                            .domain(uniqueCat)
                            .range(d3[colorScaleName]);
                        break;
                    // if sequential color scale
                    case 'seq':
                        // convert string array to number array without taking into account undefined values
                        uniqueCatNb = [];
                        for (i=0 ; i<uniqueCat.length ; i++) {
                        	if ((uniqueCat[i] != '') && (isNaN(Number(uniqueCat[i])) == false)) {
                        	    uniqueCatNb.push(Number(uniqueCat[i]))
                            } else {
                                var textValues = true;
                                break;
                            }
                        }
                        // if categories are text values, lighter color for first row and darker for last row
                        if (textValues == true) {
                            var colorScale = d3.scaleSequential()
                                .domain([1, uniqueCat.length])
                                .interpolator(d3[colorScaleName]);
                        // else, interpolates color based upon category values	
                        } else {
                            var colorScale = d3.scaleSequential()
                                .domain([Math.min(...uniqueCatNb), Math.max(...uniqueCatNb)])
                                .interpolator(d3[colorScaleName]);
                        }
                        break;
                }
                return colorScale;
            }
            
            //function mmmsetColorScale() {
            //	colorScale = document.getElementById('colorScale').value;
            //}
            

            // update categories table everytime a new category column or color scale is selected
            function updateCat() {
                // if category column is selected
                colCat = document.getElementById("colCat").selectedIndex - 1;
                // get category list with all occurrences
                if (colCat != -1) {
                    catList = inputArray[colCat];
            	   // get only unique values
            	   uniqueCat = [...new Set(catList)];
            	   // create object where keys are unique categories and values are stocks for this category
            	   // for ex. {'cat1' : 5, 'cat2' : 12, 'cat3' : 1}
            	   dicCat = {};
            	   for (i=0 ; i<catList.length ; i++) {
            	   	  if (dicCat[catList[i]]) { 
            	   	      dicCat[catList[i]] = dicCat[catList[i]] + 1
            	   	  } else {
            	   	  	dicCat[catList[i]] = 1
            	   	  }
            	   }
            	// else there's only one category : 'Tout' ('All')
            	} else {
            	    catList = Array(inputArray[0].length).fill('Tout');
                    uniqueCat = ['Tout'];
                    dicCat = {'Tout' : catList.length}
            	}
            	
            	
            	// clean table
            	table = document.getElementById("catTableTbody");
            	for(var i = table.rows.length - 1 ; i >= 0 ; i--) {
                    table.deleteRow(i);
                }
                
                // get color scale
                colorScale = setColorScale(Object.keys(dicCat));
                
                // update table
            	for (var key in dicCat) {
            		row = table.insertRow(-1);
            		cellName = row.insertCell(0);
            		cellName.innerHTML = key;
            		cellColor = row.insertCell(1);
            		// if sequential color scale, scale return a rgb color which must be converted to hex
            		if (colorScaleType == 'seq') {
            		  // black for undefined values
            		  if (key == '') {
            		  	catColor = '#000000';
            		  } else {
            		      // if category value is a number, uses that number
            		      if (isNaN(Number(key)) == false) {
            		          catColor = d3.color(colorScale(Number(key))).hex()
            		      // else, use row number	
            		      } else {
            		          catColor = d3.color(colorScale(row.rowIndex)).hex();
            		      }
            		  }
            		// qualitative color scale is simpler 
            		} else {
            			catColor = colorScale(key)
            		}
            		cellColor.innerHTML = '<input class="colorPicker form-control" type="color" value="' + catColor + '">';
            		cellStock = row.insertCell(2);
            		cellStock.innerHTML = dicCat[key];
            	}
            	
            	//// stores categories and their colors
            	//getColorsForCat();
            	
                // make table sortable
                $.bootstrapSortable({ applyLast: true })
            }
            
            
            // when category table get sorted, colors do not get reordered
            function reorderColors() {
                table = document.getElementById("catTableTbody");
            	// for each row
            	for (i=0 ; i<table.rows.length ; i++) {
            	   // calculate color value
            	   catColor = colorsForCat[i][1];
            	   // fill table with this color value
            	   table.rows[i].cells[1].innerHTML = '<input class="colorPicker form-control" type="color" value="' + catColor + '">';
            	}   
            }
            
            
            // get color for each category : [['A', '#66c2a5'], ['B', '#fc8d62'], ...]
            function getColorsForCat() {
            	colorsForCat = [];
            	var table = document.getElementById('catTable');
            	for (var r = 1 ; r < table.rows.length ; r++) {
            	    currentCat = table.rows[r].cells[0].innerHTML;
                    currentColor = table.rows[r].cells[1].children[0].value;
            	    colorsForCat.push([]);
            	    colorsForCat[r-1].push(currentCat);
            	    colorsForCat[r-1].push(currentColor);
            	}
            }

            
            // put csv file content into a variable
            function readCsv() {
                // fetch csv content
                inputCsv = document.getElementById('inputFile').files[0];
                // check if file name ends with .csv
                if (inputCsv['name'].substr(inputCsv['name'].length - 4) != '.csv') {
                	window.alert("Choisissez un fichier avec l'extension .csv");
                	return false;
                }
                // CSV parsing
                Papa.parse(inputCsv, {
            	    header: false,
            	    skipEmptyLines: true,
            	    // once csv is parsed, read it
            	    complete: function(results, file) {
                        //console.log("Parsing complete:", results, file);
                        inputArray = results['data'];
                        // displays CSV preview
                        csvPreview(inputArray);
                        results = csvToArray(inputArray);
                        inputArray = results[0];
                        // remove options for columns combobox
                        for(i = document.getElementById('colYear').options.length-1; i>=0; i--) {
                            document.getElementById('colYear').remove(i);
                            document.getElementById('colSex').remove(i);
                            document.getElementById('colCat').remove(i);
                            document.getElementById('colTooltip').remove(i);
                        }
                        // set an empty option (selected by default) for columns combobox
                        // (if there's no empty option, the category table might get populated by lots of value which might be confusing)
                        document.getElementById('colYear').options.add(new Option('-- aucune colonne--', ''));
                        document.getElementById('colSex').options.add(new Option('-- aucune colonne--', ''));
                        document.getElementById('colCat').options.add(new Option('-- aucune colonne--', ''));
                        document.getElementById('colTooltip').options.add(new Option('-- aucune colonne--', ''));
                        // set options for columns combobox
                        columnNames = results[1];
                        for (i = 0; i < columnNames.length; i++) {
                            document.getElementById('colYear').options.add(new Option(columnNames[i], columnNames[i]));
                            document.getElementById('colSex').options.add(new Option(columnNames[i], columnNames[i]));
                            document.getElementById('colCat').options.add(new Option(columnNames[i], columnNames[i]));
                            document.getElementById('colTooltip').options.add(new Option(columnNames[i], columnNames[i]));
                        }
                        
                        // reinitializes width and height of svg
                        svg_width = (window.innerWidth)*8/13; 
                        svg_height = 500;
                        svg
                            .attr('width', svg_width)
                            .attr('height', svg_height)
                        // clean svg
                        svg.selectAll("*").remove();
                        
                        // update category table
                        updateCat();
                    }
                });
            }
            
            
            // generate labels for y axis, for ex. -25, 25-30, 30-35...
            function getAgeLabels(listBeginClass) {
                // first label is for ex. -25 if beginFirstClass is 25
                ageLabels = ['-' + String(beginFirstClass)];
                // following labels, 25-29, 30-34, 35-39 etc.
            	for (i=1; i<listBeginClass.length-1; i++) {
            		ageLabels.push(String(listBeginClass[i]) + '-' + String(listBeginClass[i+1] - 1));
            	}
            	// last label, for ex. +65 if endLastClass = 65
            	ageLabels.push('+' + String(endLastClass));
            	return ageLabels;
            }
            
            
            // class size, beginning of first class and end of last class must be coherent
            function setEndLastClass() {
                // initialize variables
                var listEndLastClass = [];
                classSize = Number(document.getElementById("classSize").value);
                beginFirstClass = Number(document.getElementById("beginFirstClass").value);
            	// remove all elements from endLastClass
            	selectBox = document.getElementById("endLastClass")
            	var i;
                for(i = selectBox.options.length-1 ; i>=0 ; i--) {
                    selectBox.remove(i);
                }
            	// calculate possible values for endLastClass
            	var j = beginFirstClass + classSize
            	listEndLastClass.push(j)
            	do {
            	    j = j + classSize   
                    listEndLastClass.push(j);
            	} while (j < 120)
            	// populate select element with these values
            	for (i=0 ; i<listEndLastClass.length ; i++) {
            		var option = document.createElement("option")
            		option.text = listEndLastClass[i];
            		selectBox.add(option);
            	}
            	// get value from listEndLastClass nearest 67
            	def = 67 - (67 - beginFirstClass)%classSize;
            	// set this value as default in select box
            	if (listEndLastClass.indexOf(def) != -1) {
            		selectBox.value = def;
            	} else {
            		selectBox.value = listEndLastClass[0];
            	}
            }
            
            
            // create an object which will contain all the data needed to create the age pyramid
            function prepareGraph() {
                /*
                Creates empty object upon which the graph will be based, one object per sex
                keys are categories, values are lists with as many values as age classes
                values are list of names (or whatever) for persons in that age class and category
                for ex. {'permanent workers':[[],['helen'],[],['kate','jane'],['emily','joan','sarah'],['jenna']], 
                'temp workers':[['mary','tess','meg'],['mel'],[],[],[]] } with 5 age classes
                */
                listBeginClass = getClasses(beginFirstClass, endLastClass, classSize);
                dic_f = {};
                dic_m = {};
                for (i=0; i<catList.length; i++) {
                	dic_f[catList[i]] = [];
                	dic_m[catList[i]] = [];
                	for (j=0; j<listBeginClass.length; j++) {
                		dic_f[catList[i]].push([]);
                		dic_m[catList[i]].push([]);
                	}
                }
                
                // fills this dictionary
                for (i=0; i<inputArray[0].length; i++) {
                    nbAgeClass = getAgeClass(inputArray[colYear][i], currentYear, listBeginClass, classSize);
                    if (colCat != -1) {
                        currentCat = inputArray[colCat][i];
                    } else {
                    	currentCat = 'Tout';
                    }
                    if (colTooltip != -1) {
                    	currentTooltip = inputArray[colTooltip][i];
                    } else {
                    	currentTooltip = ''
                    }
                    if (document.getElementById('sexRep').value == 'noGender') {
                    	dic_m[currentCat][nbAgeClass].push(currentTooltip);
                    } else {
                    	if (femaleSex.indexOf(inputArray[colSex][i]) >= 0) {
                            dic_f[currentCat][nbAgeClass].push(currentTooltip);
                    	}
                    	if (maleSex.indexOf(inputArray[colSex][i]) >= 0) {
                            dic_m[currentCat][nbAgeClass].push(currentTooltip);
                    	}
                	}
                }
                
                // get max for x axis
                max_f = getMaxX(dic_f, listBeginClass);                
                max_m = getMaxX(dic_m, listBeginClass);
                max_x = Math.max(max_f, max_m);
                
                // set square side so that graph fits in svg
                squareSide = Math.min((svg_width-2*graphMargin-middleSpace)/(max_x*2), (svg_height-2*graphMargin)/listBeginClass.length);
                // square side should not be less than minSquareSide, if necessary svg should be scrollable
                if (squareSide < minSquareSide) {
                	squareSide = minSquareSide;
                	svg_width = Math.max(max_x * 2 * minSquareSide + middleSpace + 2 * graphMargin, svg_width);
                	svg_height = Math.max(listBeginClass.length * minSquareSide + 2 * graphMargin, svg_height);
                // it can be necessary to reset values (if user changed parameters)
                } else {
                	svg_width = (window.innerWidth)*8/13; 
                    svg_height = 500;
                    squareSide = Math.min((svg_width-2*graphMargin-middleSpace)/(max_x*2), (svg_height-2*graphMargin)/listBeginClass.length);
                }
                // resize svg
                svg
                    .attr('width', svg_width)
                    .attr('height', svg_height)
                //// resize graph div to make it the same size as svg
                //document.getElementById('graph').setAttribute("style","width:" + svg_width + "px");
                //document.getElementById('graph').setAttribute("style","height:" + svg_height + "px");
                
                // set domain and range for x axis, female and male
                x_scale_f.domain([0, max_x]);   
                x_scale_f.range([svg_width/2 + middleSpace/2, svg_width/2 + max_x*squareSide + middleSpace/2]);   
                x_scale_m.domain([0, max_x]);   
                x_scale_m.range([svg_width/2 - middleSpace/2, svg_width/2 - max_x*squareSide - middleSpace/2]); 
                
                // set domain and range for y axis
                ageLabels = getAgeLabels(listBeginClass);
                y_scale_f.domain(ageLabels);
                y_scale_f.range([svg_height-graphMargin, svg_height-graphMargin-listBeginClass.length*squareSide]);
                y_scale_m.domain(ageLabels);
                y_scale_m.range([svg_height-graphMargin, svg_height-graphMargin-listBeginClass.length*squareSide]);
                
            } // end of prepareGraph function
            
            
            // download graph as svg
            // see https://stackoverflow.com/questions/16870876/writing-html-form-data-to-a-txt-file-without-the-use-of-a-webserver
            function download() {
            	copyText = document.getElementById("graph").innerHTML;
                var pom = document.createElement('a');
                pom.setAttribute('href', 'data:text/plain;charset=utf-8,' + 
                encodeURIComponent(copyText));
                pom.setAttribute('download', 'pyramidage.svg');
                pom.style.display = 'none';
                document.body.appendChild(pom);
                pom.click();
                document.body.removeChild(pom);
            }
            
            
            function letsGraph() {
            
                // retrieve user parameters
                currentYear = Number(document.getElementById("currentYear").value);
                colYear = document.getElementById("colYear").selectedIndex -1;
                colSex = document.getElementById("colSex").selectedIndex - 1;
                colCat = document.getElementById("colCat").selectedIndex - 1;
                colTooltip = document.getElementById("colTooltip").selectedIndex - 1;
                classSize = Number(document.getElementById("classSize").value);
                beginFirstClass = Number(document.getElementById("beginFirstClass").value);
                endLastClass = Number(document.getElementById("endLastClass").value);
                sexRep = document.getElementById('sexRep').value;
                
                // a CSV file must be selected
                if (document.getElementById('inputFile').files[0] == null) {
                    window.alert("Choisissez un fichier CSV contenant vos données en cliquant sur le bouton Parcourir");
                	return false;
                }
                // birth year and sex are mandatory
                if ((colYear == -1) && (colSex == -1)) {
                    if (sexRep != 'noGender') {
                	   window.alert("Choisissez une colonne pour l'année de naissance et pour le sexe");
                	   return false;
                    } else {
                       window.alert("Choisissez une colonne pour l'année de naissance");
                	   return false;
                    }
                }
                if (colYear == -1) {
                	window.alert("Choisissez une colonne pour l'année de naissance");
                	return false;
                }
                if ((colSex == -1) && (sexRep != 'noGender')) {
                	window.alert("Choisissez une colonne pour le sexe");
                	return false;
                }
                
                // preparing
                prepareGraph();
                
                // remove all existing elements
                svg.selectAll("*").remove();
                
            	// create graphic from dic_f and dic_m
            	sexRep = document.getElementById('sexRep').value;
            	switch (sexRep) {
            		case 'menLeft':
            		  createGraph(dic_f, 'f', max_x);
                      createGraph(dic_m, 'm', max_x);
                      break;
                    case 'womenLeft':
            		  createGraph(dic_f, 'm', max_x);
                      createGraph(dic_m, 'f', max_x);
                      break;
                    case 'noGender':
                      createGraph(dic_m, 'm', max_x);
                      break;
            	}
                
                
                // add legend
                createLegend();
                
                // add sex indication if relevant
                addSexIndication();
                
                // resize graph div to make it the same size as svg
                realSvgWidth = svg.style("width");
                realSvgHeight = svg.style("height");
                document.getElementById('graph').setAttribute("style","width:" + realSvgWidth + "px");
                document.getElementById('graph').setAttribute("style","height:" + realSvgHeight + "px");
                
            }
        
            
            /*
            SCRIPT
            */
            
            // display CSV file name
            $("#inputFile").change(function() {
                filename = this.files[0].name;
                document.getElementById("fileName").innerHTML = filename;
            });
            
            // no CSV file is selected when page is (re)loaded
            document.getElementById('inputFile').value = '';
            
            // populate list with possible values for end of last age class
            setEndLastClass();
            
            // when CSV file is selected by user, get column names etc. so that user can choose parameters
            document.getElementById("inputFile").addEventListener('input', readCsv);
            
            // update category table when user changes category column
            document.getElementById("colCat").addEventListener('change', updateCat);
            
            // update endLastClass when user changes classSize or beginFirstClass
            document.getElementById("classSize").addEventListener('input', setEndLastClass);
            document.getElementById("beginFirstClass").addEventListener('input', setEndLastClass);
            
            // when user wants to create pyramid
            document.getElementById("createGraph").addEventListener('click', letsGraph);
            
            // when user wants to export pyramid as SVG
            document.getElementById("svgExport").addEventListener('click', download);
            
            // makes table sortable by drag and drop
            $('tbody').sortable();
            
            // make table sortable by clicking on column names
            $.bootstrapSortable({ applyLast: true });
            
            // color order should not change when category table get sorted
            //$('#catTable').on('sorted', reorderColors);
            
            // populate color scale type dropdown list
            document.getElementById('colorScaleType').options.add(new Option('qualitative', 'quali'));
            document.getElementById('colorScaleType').options.add(new Option('séquentielle', 'seq'));
            
            // populate color scales qualitative and sequential dropdown lists
            populateColorScale();
            document.getElementById("colorScaleType").addEventListener('change', populateColorScale);
            
            // populate sex repartition dropdown list
            document.getElementById('sexRep').options.add(new Option('hommes à gauche', 'menLeft'));
            document.getElementById('sexRep').options.add(new Option('femmes à gauche', 'womenLeft'));
            document.getElementById('sexRep').options.add(new Option('non genrée', 'noGender'));
            
            // update category table when colorScaleType gets changed
            document.getElementById("colorScaleType").addEventListener('change', updateCat);
            
            // update category table when user changes color scale
            document.getElementById("colorScale").addEventListener('change', updateCat);
            
            
        </script>
        
    </body>
</html>
